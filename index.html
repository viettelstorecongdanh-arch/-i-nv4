// --- CẤU HÌNH CỘT (QUAN TRỌNG) ---
    // Hãy sửa số này tương ứng với cột trong Sheet của bạn (A=0, B=1, C=2...)
    const COL_ID    = 0; // Cột Mã SP
    const COL_NAME  = 1; // Cột Tên SP
    const COL_IMEI  = 2; // Cột IMEI
    const COL_PRICE = 5; // Cột Giá Bán <--- HÃY KIỂM TRA LẠI SỐ NÀY

    // Hàm hỗ trợ chuyển đổi giá tiền từ mọi định dạng (chữ, số, có dấu chấm phẩy...)
    function parsePrice(value) {
        if (!value) return 0;
        if (typeof value === 'number') return value;
        // Nếu là chữ (VD: "4.500.000 đ"), xóa hết ký tự lạ chỉ giữ lại số
        const numberString = String(value).replace(/[^0-9]/g, ""); 
        return parseInt(numberString) || 0;
    }

    async function initSystem() {
        try {
            const promises = DATA_SOURCES.map(src => 
                fetch(`https://docs.google.com/spreadsheets/d/${src.id}/gviz/tq?tqx=out:json&tq&gid=${src.gid}`)
                .then(r => r.text())
                .then(t => JSON.parse(t.substring(47).slice(0, -2)).table.rows)
            );

            const sheetsData = await Promise.all(promises);
            const productMap = new Map();

            sheetsData.flat().forEach(row => {
                const c = row.c;
                if (!c) return;

                const id = c[COL_ID]?.v || "NO_ID";
                const name = c[COL_NAME]?.v || "Chưa đặt tên";
                const imei = c[COL_IMEI]?.v ? String(c[COL_IMEI].v).trim() : null;
                
                // Sửa lỗi giá: Lấy giá trị thô (v) hoặc giá trị hiển thị (f) để xử lý
                const rawPrice = c[COL_PRICE]?.v || c[COL_PRICE]?.f || 0;
                const price = parsePrice(rawPrice);
                
                const key = id + "_" + name;

                if (!productMap.has(key)) {
                    productMap.set(key, {
                        id: id,
                        name: name,
                        price: price, // Giá đã được xử lý chuẩn
                        imeis: [],
                        source_count: 0
                    });
                }
                
                const p = productMap.get(key);
                if (imei) p.imeis.push(imei);
                
                // Logic phụ: Nếu dòng này có giá > 0 và giá cũ đang = 0 thì cập nhật giá mới
                if (price > 0 && p.price === 0) {
                    p.price = price;
                }
                
                p.source_count++;
            });

            allProducts = Array.from(productMap.values());
            
            statusBar.innerHTML = `<i class="fas fa-check-circle" style="color:green"></i> Đã tải ${allProducts.length} dòng sản phẩm.`;
            searchBox.disabled = false;
            searchBox.focus();
            render(allProducts);

        } catch (e) {
            console.error(e);
            statusBar.innerHTML = `<span style="color:red">Lỗi: ${e.message}</span>`;
        }
    }
