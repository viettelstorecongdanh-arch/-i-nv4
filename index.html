<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hệ Thống Kho Tổng Hợp</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        /* GIỮ NGUYÊN CSS GIAO DIỆN ĐẸP CỦA BẠN */
        :root { --primary: #007AFF; --bg: #F5F7FA; --card: #FFF; --text: #1D1D1F; --danger: #FF3B30; --success: #34C759; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-top: 80px; }
        
        /* Header & Search */
        .header { position: fixed; top: 0; left: 0; right: 0; background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); padding: 15px; box-shadow: 0 1px 0 rgba(0,0,0,0.05); z-index: 100; display:flex; justify-content:center; }
        .search-box { width: 100%; max-width: 600px; padding: 12px 20px; border-radius: 12px; border: 1px solid #ddd; outline: none; transition: 0.3s; background: #f9f9f9; }
        .search-box:focus { background: #fff; box-shadow: 0 4px 12px rgba(0,0,0,0.1); border-color: var(--primary); }

        /* Grid Layout */
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; }

        /* Card Style */
        .card { background: var(--card); border-radius: 12px; padding: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.03); border: 1px solid #eee; cursor: pointer; transition: 0.2s; position: relative; }
        .card:hover { transform: translateY(-3px); box-shadow: 0 8px 15px rgba(0,0,0,0.08); }
        
        .badge { position: absolute; top: 12px; right: 12px; font-size: 11px; font-weight: 700; padding: 4px 8px; border-radius: 4px; }
        .bg-green { background: #E8F5E9; color: var(--success); }
        .bg-red { background: #FFEBEE; color: var(--danger); }
        .bg-gray { background: #f0f0f0; color: #666; }

        .name { font-weight: 600; font-size: 16px; margin-bottom: 5px; line-height: 1.4; padding-right: 60px; }
        .code { font-size: 12px; color: #888; margin-bottom: 10px; font-family: monospace; }
        .price { font-size: 18px; font-weight: 700; color: #333; }
        .specs { font-size: 12px; color: #666; margin-top: 8px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(5px); z-index: 200; display: none; align-items: center; justify-content: center; opacity: 0; transition: 0.2s; }
        .modal-overlay.active { display: flex; opacity: 1; }
        .modal { background: #fff; width: 500px; max-width: 90%; border-radius: 16px; padding: 25px; max-height: 80vh; overflow-y: auto; box-shadow: 0 20px 40px rgba(0,0,0,0.2); }
        
        .imei-row { display: flex; justify-content: space-between; padding: 8px; border-bottom: 1px solid #f0f0f0; font-family: monospace; font-size: 13px; }
        .copy-btn { color: var(--primary); cursor: pointer; font-weight: 600; border:none; background:none; }
    </style>
</head>
<body>

    <div class="header">
        <input type="text" class="search-box" id="search-box" placeholder="Tìm tên, mã SP, hoặc IMEI..." disabled>
    </div>

    <div class="container">
        <div id="status-bar" style="text-align: center; margin-bottom: 10px; font-size: 13px; color: #666;">Đang tải hệ thống...</div>
        <div id="grid" class="grid"></div>
    </div>

    <div class="modal-overlay" id="modal" onclick="if(event.target===this) closeModal()">
        <div class="modal">
            <h3 id="m-name" style="margin-top:0"></h3>
            <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                <span id="m-code" style="color:#888"></span>
                <span id="m-price" style="font-weight:bold; color:var(--danger)"></span>
            </div>
            <div id="m-specs" style="background:#f9f9f9; padding:10px; border-radius:8px; font-size:13px; margin-bottom:15px;"></div>
            
            <div style="font-weight:bold; margin-bottom:10px;">Chi tiết tồn kho:</div>
            <div id="m-stock-list"></div>
            
            <button onclick="closeModal()" style="width:100%; margin-top:20px; padding:12px; background:#f0f0f0; border:none; border-radius:8px; cursor:pointer">Đóng</button>
        </div>
    </div>

<script>
    // --- CẤU HÌNH DATA WAREHOUSE (KHO DỮ LIỆU) ---
    // Loại 1: 'MASTER' (Bảng Giá/Thông số - Source of Truth) - Ảnh 0d6a33
    // Loại 2: 'IMEI' (Kho Máy - Flat Data) - Ảnh 0d6729
    // Loại 3: 'QTY' (Kho Phụ Kiện - Số lượng) - Ảnh 0d6a50

    const DATABASES = [
        { 
            type: 'MASTER', 
            name: 'Bảng Giá Chuẩn',
            id: '1HrBaQHwOKL5wcAphrVS5Kej5s2lKtvRajT__VMCP8WI', // ID Sheet Giá
            gid: '0',
            cols: { id: 0, name: 1, price: 3, specs: 4 } // Cấu hình cột: A=0, B=1, D=3 (Giá KM), E=4 (Thông số)
        },
        { 
            type: 'IMEI', 
            name: 'Kho Máy Apple',
            id: '1HrBaQHwOKL5wcAphrVS5Kej5s2lKtvRajT__VMCP8WI', // ID Sheet Kho IMEI
            gid: '123456', // THAY GID CỦA SHEET KHO IMEI VÀO ĐÂY
            cols: { id: 0, imei: 2 } // A=0 (Mã), C=2 (IMEI) - Theo ảnh 0d6729
        },
        { 
            type: 'QTY', 
            name: 'Kho Phụ Kiện',
            id: '1HrBaQHwOKL5wcAphrVS5Kej5s2lKtvRajT__VMCP8WI', // ID Sheet Kho PK
            gid: '789012', // THAY GID CỦA SHEET KHO PK VÀO ĐÂY
            cols: { id: 2, qty: 3 } // C=2 (Mã MH), D=3 (Số lượng) - Theo ảnh 0d6a50
        }
    ];

    let productMap = new Map(); // Kho chứa dữ liệu hợp nhất
    const statusBar = document.getElementById('status-bar');

    async function init() {
        try {
            // 1. Tải tất cả các nguồn dữ liệu song song
            const promises = DATABASES.map(db => 
                fetch(`https://docs.google.com/spreadsheets/d/${db.id}/gviz/tq?tqx=out:json&tq&gid=${db.gid}`)
                .then(r => r.text())
                .then(t => ({ 
                    type: db.type, 
                    rows: JSON.parse(t.substring(47).slice(0, -2)).table.rows,
                    cols: db.cols 
                }))
            );

            const results = await Promise.all(promises);

            // 2. BƯỚC XỬ LÝ DỮ LIỆU (QUAN TRỌNG)
            
            // Bước 2a: Xây dựng khung xương từ bảng MASTER trước
            const masterDB = results.find(r => r.type === 'MASTER');
            if(masterDB) {
                masterDB.rows.forEach(row => {
                    const c = row.c;
                    if(!c) return;
                    const id = c[masterDB.cols.id]?.v;
                    if(!id) return;

                    productMap.set(id, {
                        id: id,
                        name: c[masterDB.cols.name]?.v || 'Chưa đặt tên',
                        price: c[masterDB.cols.price]?.v || 0,
                        specs: c[masterDB.cols.specs]?.v || '',
                        imeis: [],
                        qty: 0,
                        has_imei: false // Cờ đánh dấu xem sản phẩm này quản lý theo IMEI hay số lượng
                    });
                });
            }

            // Bước 2b: Đắp thịt (IMEI) vào khung
            const imeiDBs = results.filter(r => r.type === 'IMEI');
            imeiDBs.forEach(db => {
                db.rows.forEach(row => {
                    const c = row.c;
                    if(!c) return;
                    const id = c[db.cols.id]?.v; // Lấy Mã SP
                    const imei = c[db.cols.imei]?.v;

                    if(id && imei) {
                        // Nếu mã này chưa có trong Master, tạo mới tạm thời
                        if(!productMap.has(id)) {
                             productMap.set(id, { id: id, name: 'Sản phẩm mới (Chưa có giá)', price: 0, imeis: [], qty: 0, has_imei: true });
                        }
                        const p = productMap.get(id);
                        p.imeis.push(String(imei));
                        p.qty++; // Tăng số lượng tồn kho
                        p.has_imei = true;
                    }
                });
            });

            // Bước 2c: Đắp thịt (Số lượng Phụ kiện) vào khung
            const qtyDBs = results.filter(r => r.type === 'QTY');
            qtyDBs.forEach(db => {
                db.rows.forEach(row => {
                    const c = row.c;
                    if(!c) return;
                    const id = c[db.cols.id]?.v; // Lấy Mã MH (Code)
                    const qty = c[db.cols.qty]?.v || 0;

                    if(id) {
                        if(!productMap.has(id)) {
                             productMap.set(id, { id: id, name: 'Phụ kiện mới', price: 0, imeis: [], qty: 0, has_imei: false });
                        }
                        const p = productMap.get(id);
                        p.qty += Number(qty);
                    }
                });
            });

            // 3. Hiển thị
            const allProducts = Array.from(productMap.values());
            statusBar.innerText = `Đã đồng bộ: ${allProducts.length} mã sản phẩm từ 3 nguồn.`;
            document.getElementById('search-box').disabled = false;
            render(allProducts);

            // Setup Search
            document.getElementById('search-box').addEventListener('input', (e) => {
                const term = e.target.value.toLowerCase();
                const filtered = allProducts.filter(p => 
                    p.name.toLowerCase().includes(term) || 
                    String(p.id).toLowerCase().includes(term) ||
                    p.imeis.some(i => i.toLowerCase().includes(term))
                );
                render(filtered);
            });

        } catch (e) {
            console.error(e);
            statusBar.innerHTML = `<span style="color:red">Lỗi dữ liệu: Hãy kiểm tra ID và GID của các Sheet.</span>`;
        }
    }

    function render(data) {
        const grid = document.getElementById('grid');
        grid.innerHTML = data.map(p => {
            const stockClass = p.qty > 0 ? 'bg-green' : 'bg-red';
            const stockText = p.qty > 0 ? `Sẵn hàng: ${p.qty}` : 'Hết hàng';
            const priceText = p.price > 0 ? p.price.toLocaleString() + 'đ' : 'Liên hệ';

            return `
            <div class="card" onclick='openModal(${JSON.stringify(p).replace(/'/g, "")})'>
                <div class="badge ${stockClass}">${stockText}</div>
                <div class="name">${p.name}</div>
                <div class="code">#${p.id}</div>
                <div class="price">${priceText}</div>
                ${p.specs ? `<div class="specs">${p.specs}</div>` : ''}
            </div>`;
        }).join('');
    }

    // Modal Logic
    window.openModal = (p) => {
        document.getElementById('m-name').innerText = p.name;
        document.getElementById('m-code').innerText = '#' + p.id;
        document.getElementById('m-price').innerText = p.price > 0 ? p.price.toLocaleString() + 'đ' : 'Liên hệ';
        document.getElementById('m-specs').innerText = p.specs || 'Không có thông số chi tiết.';
        
        const stockList = document.getElementById('m-stock-list');
        if(p.has_imei && p.imeis.length > 0) {
            stockList.innerHTML = p.imeis.map(i => `
                <div class="imei-row">
                    <span>${i}</span>
                    <button class="copy-btn" onclick="navigator.clipboard.writeText('${i}')">COPY</button>
                </div>
            `).join('');
        } else if (p.qty > 0) {
            stockList.innerHTML = `<div style="padding:10px; background:#e8f5e9; color:green">Sản phẩm quản lý theo số lượng. Tồn kho: <b>${p.qty}</b></div>`;
        } else {
            stockList.innerHTML = '<div style="padding:10px; color:#999">Hết hàng.</div>';
        }

        document.getElementById('modal').classList.add('active');
    }
    window.closeModal = () => document.getElementById('modal').classList.remove('active');

    init();
</script>
</body>
</html>
